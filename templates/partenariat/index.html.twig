{% extends 'base.html.twig' %}

{% block title %}Listes Des Partenariats{% endblock %}

{% block body %}
    <div class="container mt-5">
        <div class="text-center">
            <h1 class="mb-4">Listes Des Partenariats</h1>

            <!-- Formulaire de recherche par date -->
            <form method="get" action="{{ path('app_partenariat_index') }}" class="d-inline-block w-75 mb-4" id="searchForm">
                <div class="row g-2 justify-content-center">
                    <div class="col-md-4">
                        <input type="date" name="dateDebut" class="form-control" value="{{ dateDebut }}" required>
                    </div>
                    <div class="col-md-4">
                        <input type="date" name="dateFin" class="form-control" value="{{ dateFin }}" required>
                    </div>
                    <div class="col-md-2">
                        <button type="submit" class="btn btn-custom-maj border-0 rounded-pill py-2 px-3 w-100">
                            <i class="fas fa-search"></i> Rechercher
                        </button>
                    </div>
                </div>
            </form>
        </div>

        {% if app.user %}
            <a href="{{ path('app_partenariat_new') }}" class="btn btn-custom-maj border-0 rounded-pill py-2 px-3 mb-3">
                <i class="fas fa-edit fa-1.5x"></i> Ajouter un partenariat
            </a>
        {% endif %}

        <div class="row">
            {% for partenariat in pagination.items %}
                <div class="col-md-4">
                    <div class="card service-item shadow-lg rounded-lg mb-4 position-relative" 
                        onclick="window.location.href='{{ path('app_partenariat_show', {'id': partenariat.id}) }}';"
                        style="cursor: pointer;">
                        
                        <span class="badge position-absolute top-0 end-0 m-2 px-3 py-2 text-white 
                            {% if partenariat.statut|trim|lower == 'actif' %} bg-success
                            {% elseif partenariat.statut|trim|lower == 'en cours' %} bg-warning
                            {% elseif partenariat.statut|trim|lower == 'expiré' %} bg-danger
                            {% else %} bg-secondary {% endif %}">
                            {{ partenariat.statut }}
                        </span>

                        {% if partenariat.image %}
                            <img src="{{ asset('uploads/partenariats/' ~ partenariat.image) }}" class="card-img-top" alt="{{ partenariat.nom }}" style="height: 200px; object-fit: cover;">
                        {% else %}
                            <div class="card-img-top d-flex align-items-center justify-content-center bg-light" style="height: 200px;">
                                <p class="text-muted">Aucune image</p>
                            </div>
                        {% endif %}

                        <div class="card-body text-center">
                            <h5 class="card-title text-dark">{{ partenariat.nom }}</h5>
                            <p class="card-text text-muted"><strong>Type:</strong> {{ partenariat.type }}</p>
                            <p class="card-text">{{ partenariat.description }}</p>
                            <p class="text-secondary"><strong>Début:</strong> {{ partenariat.dateDebut ? partenariat.dateDebut|date('Y-m-d') : 'Non défini' }}</p>
                            <p class="text-secondary"><strong>Fin:</strong> {{ partenariat.dateFin ? partenariat.dateFin|date('Y-m-d') : 'Non défini' }}</p>

                            <a href="{{ path('app_partenariat_edit', {'id': partenariat.id}) }}" class="btn btn-primary border-0 rounded-pill py-2 px-5">Modifier</a>
                        </div>
                    </div>
                </div>
            {% else %}
                <p class="text-center">Aucun partenariat trouvé.</p>
            {% endfor %}
        </div>

        <!-- Pagination -->
        <div class="pagination mt-4 text-center">
            {{ knp_pagination_render(pagination) }}
        </div>

        <!-- Overlay -->
        <div id="overlay" class="overlay d-none">
            <!-- Bouton de fermeture -->
            <button onclick="closeOverlay()" class="btn-close position-absolute top-0 end-0 m-3"></button>

            <div class="container">
                <h4 class="text-center">Résultats de Recherche</h4>
                <div id="searchResultsContent" class="row">
                    <!-- Résultats affichés ici -->
                </div>
            </div>
        </div>

        <style>
            .service-item {
                background-color: #FFFCF8;
                transition: all 0.3s ease-in-out;
            }

            .service-item:hover {
                background-color: #D4A762;
                color: white;
                transform: scale(1.05);
            }

            .btn-custom-maj {
                background-color: #D4A762;
                color: white;
                transition: all 0.3s ease-in-out;
            }

            .btn-custom-maj:hover {
                background-color: beige;
                color: #D4A762;
                border: 1px solid #D4A762;
            }

            /* Overlay */
            .overlay {
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background-color: rgba(0, 0, 0, 0.7);
                display: flex;
                justify-content: center;
                align-items: center;
                z-index: 1000;
                backdrop-filter: blur(5px);
                overflow-y: auto;
            }

            .overlay.d-none {
                display: none;
            }

            .btn-close {
                background-color: red;
                border-radius: 50%;
                width: 30px;
                height: 30px;
                color: white;
            }

            .btn-close:hover {
                background-color: darkred;
            }

            .pagination {
                display: block;
            }

            .overlay .row {
                display: flex;
                flex-wrap: wrap;
                gap: 1rem;
                justify-content: center;
            }
        </style>
    </div>

    <script>
        document.getElementById('searchForm').addEventListener('submit', function(event) {
            event.preventDefault();

            const dateDebut = document.querySelector('input[name="dateDebut"]').value;
            const dateFin = document.querySelector('input[name="dateFin"]').value;

            fetch(`{{ path('app_partenariat_index') }}?dateDebut=${dateDebut}&dateFin=${dateFin}`)
                .then(response => response.text())
                .then(html => {
                    let content = `<p><strong>Date Début:</strong> ${dateDebut || 'Non défini'}</p>`;
                    content += `<p><strong>Date Fin:</strong> ${dateFin || 'Non défini'}</p>`;

                    const tempDiv = document.createElement('div');
                    tempDiv.innerHTML = html;

                    const partnerships = tempDiv.querySelectorAll('.card');
                    partnerships.forEach(partnership => {
                        content += `<div class="col-md-4">${partnership.outerHTML}</div>`;
                    });

                    document.getElementById('searchResultsContent').innerHTML = `<div class="row">${content}</div>`;

                    document.getElementById('overlay').classList.remove('d-none');
                });
        });

        function closeOverlay() {
            document.getElementById('overlay').classList.add('d-none');
        }
    </script>
{% endblock %}